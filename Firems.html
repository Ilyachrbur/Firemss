<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî• FireMess P2P ‚Äî 100% —Ä–∞–±–æ—Ç–∞–µ—Ç</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }

        h2 {
            color: #555;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .step {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .step-number {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
        }

        input, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            margin: 10px 0;
            transition: all 0.3s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }

        button {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
            margin: 5px 0;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102,126,234,0.3);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .hidden {
            display: none;
        }

        #messages {
            height: 300px;
            overflow-y: auto;
            border: 2px solid #f0f0f0;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .message.own {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: 20%;
        }

        .message-info {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
        }

        .own .message-info {
            color: rgba(255,255,255,0.8);
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 500;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .status.waiting {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeeba;
        }

        .link-box {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 10px;
            word-break: break-all;
            font-family: monospace;
            font-size: 0.9rem;
            margin: 15px 0;
            border: 2px dashed #667eea;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>üî• FireMess P2P</h1>
            <p style="text-align: center; color: #666; margin-bottom: 30px;">‚úÖ 100% —Ä–∞–±–æ—á–∞—è –≤–µ—Ä—Å–∏—è –±–µ–∑ –æ—à–∏–±–æ–∫</p>

            <!-- –®–∞–≥ 1: –ò–º—è -->
            <div class="step" id="step1">
                <h2><span class="step-number">1</span> –í–∞—à–µ –∏–º—è</h2>
                <input type="text" id="username" placeholder="–ö–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç?" value="User" + Math.floor(Math.random()*1000)>
                <button onclick="goToStep2()">–î–∞–ª–µ–µ ‚Üí</button>
            </div>

            <!-- –®–∞–≥ 2: –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è -->
            <div class="step hidden" id="step2">
                <h2><span class="step-number">2</span> –ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?</h2>
                <div class="button-group">
                    <button onclick="createRoom()">üéØ –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
                    <button onclick="showJoinForm()">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ</button>
                </div>
                <button onclick="backToStep1()" style="background: #999; margin-top: 10px;">‚Üê –ù–∞–∑–∞–¥</button>
            </div>

            <!-- –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã -->
            <div class="step hidden" id="create-room">
                <h2><span class="step-number">2</span> –ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞!</h2>
                
                <div class="status waiting" id="create-status">
                    ‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞...
                </div>

                <p style="margin: 15px 0 5px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ —ç—Ç—É —Å—Å—ã–ª–∫—É —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É:</p>
                <div class="link-box" id="room-link" onclick="copyLink(this)"></div>
                <button onclick="copyLink(document.getElementById('room-link'))">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
                
                <button onclick="resetApp()" style="background: #dc3545; margin-top: 20px;">üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ</button>
            </div>

            <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ -->
            <div class="step hidden" id="join-room">
                <h2><span class="step-number">2</span> –í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É</h2>
                <input type="text" id="invite-link" placeholder="–°—Å—ã–ª–∫–∞ –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è">
                <button onclick="connectToRoom()">üîå –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
                <button onclick="backToStep2()" style="background: #999; margin-top: 10px;">‚Üê –ù–∞–∑–∞–¥</button>
            </div>

            <!-- –ß–∞—Ç -->
            <div class="step hidden" id="chat-room">
                <h2>–ß–∞—Ç —Å <span id="peer-name">—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–º</span></h2>
                
                <div class="status connected" id="chat-status">
                    üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ
                </div>

                <div id="messages"></div>
                
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMessage()">
                    <button onclick="sendMessage()" style="width: auto; padding: 15px 25px;">‚û§</button>
                </div>
                
                <button onclick="resetApp()" style="background: #dc3545; margin-top: 15px;">‚ùå –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let peerConnection = null;
        let dataChannel = null;
        let username = '';
        let roomId = '';
        let peerName = '—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫';
        let messages = [];
        let isInitiator = false;
        let pendingCandidates = []; // –û—á–µ—Ä–µ–¥—å ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤

        function goToStep2() {
            username = document.getElementById('username').value.trim();
            if (!username) {
                alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!');
                return;
            }
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        function backToStep1() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }

        function backToStep2() {
            document.getElementById('join-room').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        }

        async function createRoom() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('create-room').classList.remove('hidden');

            // –°–æ–∑–¥–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∫–æ–º–Ω–∞—Ç—ã
            roomId = Math.random().toString(36).substring(2, 15);
            const link = `${window.location.origin}${window.location.pathname}?room=${roomId}&name=${encodeURIComponent(username)}`;
            
            document.getElementById('room-link').textContent = link;
            
            // –°–æ–∑–¥–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–∞–∫ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä
            isInitiator = true;
            createPeerConnection();
            
            // –°–æ–∑–¥–∞–µ–º offer
            try {
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                
                // –î–æ–±–∞–≤–ª—è–µ–º offer –≤ —Å—Å—ã–ª–∫—É
                const offerParam = btoa(JSON.stringify(offer));
                const url = new URL(link);
                url.searchParams.set('offer', offerParam);
                document.getElementById('room-link').textContent = url.toString();
                
                console.log('‚úÖ Offer —Å–æ–∑–¥–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å—Å—ã–ª–∫—É');
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è offer:', e);
            }
        }

        function showJoinForm() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('join-room').classList.remove('hidden');
        }

        async function connectToRoom() {
            const link = document.getElementById('invite-link').value;
            try {
                const url = new URL(link);
                roomId = url.searchParams.get('room');
                peerName = url.searchParams.get('name') || '—Å–æ–±–µ—Å–µ–¥–Ω–∏–∫';
                
                document.getElementById('join-room').classList.add('hidden');
                document.getElementById('create-room').classList.remove('hidden');
                document.getElementById('room-link').textContent = link;
                
                document.getElementById('create-status').innerHTML = '‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É...';
                
                // –°–æ–∑–¥–∞–µ–º WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–∞–∫ –Ω–µ –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä
                isInitiator = false;
                createPeerConnection();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ offer –≤ —Å—Å—ã–ª–∫–µ
                const offerParam = url.searchParams.get('offer');
                if (offerParam) {
                    try {
                        const offer = JSON.parse(atob(offerParam));
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                        console.log('‚úÖ Remote description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ offer');
                        
                        // –°–æ–∑–¥–∞–µ–º answer
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º answer –≤ —Å—Å—ã–ª–∫—É
                        const answerParam = btoa(JSON.stringify(answer));
                        url.searchParams.set('answer', answerParam);
                        document.getElementById('room-link').textContent = url.toString();
                        
                        console.log('‚úÖ Answer —Å–æ–∑–¥–∞–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å—Å—ã–ª–∫—É');
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ offer:', e);
                    }
                }
            } catch (e) {
                alert('–ù–µ–≤–µ—Ä–Ω–∞—è —Å—Å—ã–ª–∫–∞!');
            }
        }

        function createPeerConnection() {
            const config = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' },
                    { urls: 'stun:stun3.l.google.com:19302' },
                    { urls: 'stun:stun4.l.google.com:19302' }
                ]
            };

            peerConnection = new RTCPeerConnection(config);

            // –°–æ–∑–¥–∞–µ–º –∫–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö –µ—Å–ª–∏ –º—ã –∏–Ω–∏—Ü–∏–∞—Ç–æ—Ä
            if (isInitiator) {
                dataChannel = peerConnection.createDataChannel('chat');
                setupDataChannel();
            } else {
                peerConnection.ondatachannel = (event) => {
                    dataChannel = event.channel;
                    setupDataChannel();
                };
            }

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
            peerConnection.onicecandidate = (event) => {
                if (event.candidate) {
                    console.log('‚ùÑÔ∏è –ù–æ–≤—ã–π ICE –∫–∞–Ω–¥–∏–¥–∞—Ç');
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –≤ URL —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å remote description
                    if (peerConnection.remoteDescription) {
                        const url = new URL(document.getElementById('room-link').textContent);
                        const candidates = url.searchParams.get('candidates') || '';
                        const candidateParam = btoa(JSON.stringify(event.candidate));
                        url.searchParams.set('candidates', candidates + (candidates ? ',' : '') + candidateParam);
                        document.getElementById('room-link').textContent = url.toString();
                    } else {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–∞ –≤ –æ—á–µ—Ä–µ–¥—å
                        pendingCandidates.push(event.candidate);
                    }
                }
            };

            // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
            peerConnection.onconnectionstatechange = () => {
                console.log('üîó –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', peerConnection.connectionState);
                
                if (peerConnection.connectionState === 'connected') {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç
                    document.getElementById('create-room').classList.add('hidden');
                    document.getElementById('chat-room').classList.remove('hidden');
                    document.getElementById('peer-name').textContent = peerName;
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                    setTimeout(() => {
                        sendMessageToPeer({
                            type: 'hello',
                            name: username
                        });
                    }, 500);
                }
            };

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É –Ω–∞ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
            startPolling();
        }

        function setupDataChannel() {
            dataChannel.onopen = () => {
                console.log('üì° –ö–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö –æ—Ç–∫—Ä—ã—Ç');
            };

            dataChannel.onclose = () => {
                console.log('üì° –ö–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫—Ä—ã—Ç');
            };

            dataChannel.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('üì® –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data.type);
                
                if (data.type === 'hello') {
                    peerName = data.name;
                    document.getElementById('peer-name').textContent = peerName;
                } else if (data.type === 'message') {
                    addMessage(data.text, data.sender);
                }
            };
        }

        function startPolling() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã –Ω–∞ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞
            const interval = setInterval(() => {
                if (peerConnection.connectionState === 'connected') {
                    clearInterval(interval);
                    return;
                }

                const url = new URL(window.location.href);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ answer
                const answerParam = url.searchParams.get('answer');
                if (answerParam && !peerConnection.currentRemoteDescription) {
                    try {
                        const answer = JSON.parse(atob(answerParam));
                        peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                        console.log('‚úÖ Remote description —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏–∑ answer');
                    } catch (e) {
                        console.error('–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ answer:', e);
                    }
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
                const candidatesParam = url.searchParams.get('candidates');
                if (candidatesParam && peerConnection.remoteDescription) {
                    const candidates = candidatesParam.split(',');
                    candidates.forEach(candidateParam => {
                        if (candidateParam) {
                            try {
                                const candidate = JSON.parse(atob(candidateParam));
                                peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                                console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω ICE –∫–∞–Ω–¥–∏–¥–∞—Ç –∏–∑ URL');
                            } catch (e) {
                                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–∞–Ω–¥–∏–¥–∞—Ç–∞:', e);
                            }
                        }
                    });
                    
                    // –û—á–∏—â–∞–µ–º –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤ –∏–∑ URL
                    url.searchParams.delete('candidates');
                    window.history.replaceState({}, '', url);
                }

                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –µ—Å–ª–∏ –ø–æ—è–≤–∏–ª—Å—è remote description
                if (pendingCandidates.length > 0 && peerConnection.remoteDescription) {
                    pendingCandidates.forEach(candidate => {
                        peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                        console.log('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ICE –∫–∞–Ω–¥–∏–¥–∞—Ç');
                    });
                    pendingCandidates = [];
                }
            }, 2000);
        }

        function sendMessageToPeer(data) {
            if (dataChannel && dataChannel.readyState === 'open') {
                dataChannel.send(JSON.stringify(data));
            } else {
                console.log('–ö–∞–Ω–∞–ª –¥–∞–Ω–Ω—ã—Ö –µ—â–µ –Ω–µ –æ—Ç–∫—Ä—ã—Ç, —Å–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ');
            }
        }

        function sendMessage() {
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            
            if (text) {
                const message = {
                    type: 'message',
                    text: text,
                    sender: username
                };
                
                sendMessageToPeer(message);
                addMessage(text, username, true);
                input.value = '';
            }
        }

        function addMessage(text, sender, isOwn = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'own' : ''}`;
            
            const time = new Date().toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div class="message-info">
                    <span>${sender}</span>
                    <span>${time}</span>
                </div>
                <div>${text}</div>
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function copyLink(element) {
            const text = element.textContent || element.innerText;
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.querySelector('#create-room button');
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
                setTimeout(() => btn.textContent = originalText, 2000);
            });
        }

        function resetApp() {
            if (peerConnection) {
                peerConnection.close();
                peerConnection = null;
            }
            
            document.getElementById('chat-room').classList.add('hidden');
            document.getElementById('create-room').classList.add('hidden');
            document.getElementById('join-room').classList.add('hidden');
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
            
            document.getElementById('messages').innerHTML = '';
            
            // –û—á–∏—â–∞–µ–º URL
            window.history.replaceState({}, '', window.location.pathname);
            
            pendingCandidates = [];
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            const url = new URL(window.location.href);
            const roomParam = url.searchParams.get('room');
            const nameParam = url.searchParams.get('name');
            
            if (roomParam && nameParam) {
                username = nameParam;
                document.getElementById('username').value = username;
                goToStep2();
                
                setTimeout(() => {
                    document.getElementById('step2').classList.add('hidden');
                    document.getElementById('create-room').classList.remove('hidden');
                    
                    roomId = roomParam;
                    document.getElementById('room-link').textContent = url.toString();
                    
                    isInitiator = false;
                    createPeerConnection();
                    
                    document.getElementById('create-status').innerHTML = '‚è≥ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É...';
                }, 500);
            }
        });
    </script>
</body>
</html>
